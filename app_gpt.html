<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>La Bo√Æte aux Questions</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin:0;padding:0;display:flex;justify-content:center;align-items:center;
      min-height:100vh;background:linear-gradient(135deg,#1a2a6c,#b21f1f,#1a2a6c);
      background-size:400% 400%;animation:gradientBG 15s ease infinite;color:white;
      font-family:'Segoe UI',sans-serif;text-align:center;
    }
    @keyframes gradientBG {
      0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}
    }
    .page {display:none;max-width:800px;background:rgba(0,0,0,0.7);padding:30px;border-radius:20px;}
    .page.active {display:block;}
    h1 {font-size:2.2rem;margin-bottom:20px;}
    h2 {color:#ffcc00;margin-bottom:20px;}
    ul {text-align:left;}
    button {
      margin-top:20px;padding:15px 40px;border:none;border-radius:50px;
      background:#ffcc00;color:#1a2a6c;font-weight:bold;font-size:1.2rem;cursor:pointer;
    }
    .question-container {
      background:rgba(255,255,255,0.1);padding:30px;border-radius:20px;margin-bottom:20px;
    }
    .question-text {font-size:1.4rem;font-weight:bold;margin-bottom:15px;}
    .countdown {font-size:1.2rem;margin-top:10px;color:#ffcc00;}
    .progress-bar {height:10px;background:rgba(255,255,255,0.2);border-radius:5px;margin-top:20px;}
    .progress {height:100%;background:linear-gradient(90deg,#ffcc00,#ff9900);width:0%;}
  </style>
</head>
<body>
  <!-- Page 1 : Autorisations -->
  <div id="permissionPage" class="page active">
    <h1><i class="fas fa-video"></i> Autorisations requises</h1>
    <p>Pour participer au jeu, veuillez autoriser l'acc√®s √† la cam√©ra et au micro.</p>
    <button id="permissionBtn"><i class="fas fa-check-circle"></i> Autoriser cam√©ra & micro</button>
  </div>

  <!-- Page 2 : R√®gles -->
  <div id="rulesPage" class="page">
    <h1><i class="fas fa-box"></i> La Bo√Æte aux Questions</h1>
    <h2>Bienvenue au d√©fi des moumounes üéâ</h2>
    <p><b>R√®gles :</b></p>
    <ul>
      <li>Par groupe de 1 √† 5 personnes max</li>
      <li>R√©pondez aux questions sur les moumounes, film√© et enregistr√©</li>
      <li>Une personne lit la question √† haute voix avant de r√©pondre</li>
      <li>Vous avez un temps d√©fini par question avant de passer automatiquement √† la suivante</li>
      <li>R√©pondez seul ou en groupe, √† vous de choisir</li>
      <li><b>Nous serons les seuls √† voir la vid√©o (montage ensuite possible)</b></li>
    </ul>
    <button id="startBtn"><i class="fas fa-play"></i> Commencer le Quiz</button>
  </div>

  <!-- Page 3 : Quiz -->
  <div id="quizPage" class="page">
    <div class="question-container">
      <div class="question-text" id="questionText">Chargement...</div>
      <div class="countdown" id="countdown">‚è≥ --s restantes</div>
    </div>
    <div class="progress-bar"><div class="progress" id="progress"></div></div>
    <video id="webcamPreview" autoplay muted playsinline style="margin-top:20px;width:100%;max-width:500px;border-radius:10px;transform:scaleX(-1)"></video>
  </div>

  <!-- Page 4 : Fin -->
  <div id="endPage" class="page">
    <h1>üé¨ Quiz termin√© üé¨</h1>
    <p>Merci pour votre participation ‚ù§Ô∏è</p>
  </div>

<script>
/* ===================== Donn√©es ===================== */
const questions = [
  "On commence facile : quel est l‚Äô√¢ge de Margaux et de Corentin ?",
  "Qui a fait le premier pas entre Margaux et Corentin selon vous ?",
  "Match de Bi√®re pong Corentin VS Margaux, qui gagne ?",
  "Qui fait le mieux la cuisine ?",
  "Y‚Äôa t-il un plus beau couple que les moumounes dans ce mariage ? (Si oui nommez le ! Une seule r√©ponse accord√©e)",
  "Donnez une musique qui vous rappelle un souvenir avec les moumounes (et le contexte)",
  "Racontez une anecdote dr√¥le sur Corentin ou Margaux (ou les deux !)",
  "En combien de temps les moumounes ont mont√© le col du Tourmalet ?",
  "Pensez-vous voir appara√Ætre Spider Bar ce soir ?",
  "Bonus : Qui porte la culotte ? (justifiez votre r√©ponse... ou pas üòÜ)"
];

// Dur√©es sp√©cifiques en ms
const questionDurations = [20000,45000,45000,20000,45000,45000,60000,20000,15000,20000];

/* ===================== S√©lecteurs ===================== */
const permissionPage=document.getElementById('permissionPage');
const rulesPage=document.getElementById('rulesPage');
const quizPage=document.getElementById('quizPage');
const endPage=document.getElementById('endPage');

const questionText=document.getElementById('questionText');
const countdown=document.getElementById('countdown');
const progress=document.getElementById('progress');
const startBtn=document.getElementById('startBtn');
const permissionBtn=document.getElementById('permissionBtn');
const webcamPreview=document.getElementById('webcamPreview');

/* ===================== √âtat ===================== */
let stream=null;
let mediaRecorder=null;
let recordedChunks=[];
let currentQuestion=0;
let questionTimer=null;
let hasDownloaded=false;

/* ===================== Utilitaires ===================== */
function resetForNewRun(){
  // Remettre √† z√©ro tout l'√©tat du quiz avant de (re)d d√©marrer
  currentQuestion = 0;
  clearInterval(questionTimer);
  questionTimer = null;
  questionText.textContent = "Chargement...";
  countdown.textContent = "‚è≥ --s restantes";
  countdown.style.color = "#ffcc00";
  progress.style.width = "0%";
  recordedChunks = [];
  hasDownloaded = false;
}

function goTo(page){
  // Helper d'affichage
  [permissionPage, rulesPage, quizPage, endPage].forEach(p=>p.classList.remove('active'));
  page.classList.add('active');
}

/* ===================== Permissions ===================== */
permissionBtn.addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    webcamPreview.srcObject = stream; // on montre l'aper√ßu d√®s maintenant
    goTo(rulesPage);
  }catch(e){
    alert("Impossible d'acc√©der √† la cam√©ra/micro üö´");
  }
});

/* ===================== D√©marrage Quiz ===================== */
startBtn.addEventListener('click', ()=>{
  resetForNewRun();               // ‚úÖ important : on nettoie tout l'√©tat
  goTo(quizPage);
  startRecording();
  showQuestion(0);
});

/* ===================== Enregistrement ===================== */
function startRecording(){
  recordedChunks = [];
  hasDownloaded = false;

  // (re)cr√©e un MediaRecorder propre
  mediaRecorder = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9,opus'});

  mediaRecorder.ondataavailable = e=>{
    if(e.data && e.data.size > 0) recordedChunks.push(e.data);
  };

  // G√®re le t√©l√©chargement auto et le retour aux r√®gles *une seule fois*
  mediaRecorder.onstop = ()=>{
    if (hasDownloaded) return; // garde-fou
    hasDownloaded = true;

    const blob = new Blob(recordedChunks, {type:'video/webm'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = "moumounes-quiz.webm";
    a.click();
    URL.revokeObjectURL(url);

    // Affiche "Quiz termin√©" encore quelques secondes puis retour aux r√®gles
    setTimeout(()=>{
      goTo(rulesPage);
      resetForNewRun(); // pr√™t pour la prochaine session
    }, 3000);
  };

  mediaRecorder.start(250);
}

/* ===================== Logique d'affichage des questions ===================== */
function showQuestion(index){
  if(index >= questions.length){
    finishQuiz();
    return;
  }

  questionText.textContent = questions[index];

  const duration = questionDurations[index] || 10000;
  let remaining  = Math.ceil(duration/1000);
  let elapsed    = 0;

  countdown.textContent = `‚è≥ ${remaining}s restantes`;
  countdown.style.color = "#ffcc00";
  progress.style.width  = "0%";

  clearInterval(questionTimer);
  questionTimer = setInterval(()=>{
    elapsed += 100;

    // Mise √† jour num√©rique chaque seconde
    if (elapsed % 1000 === 0) {
      remaining--;
      countdown.textContent = `‚è≥ ${remaining}s restantes`;
      countdown.style.color = (remaining <= 3 ? "red" : "#ffcc00");
    }

    // Barre de progression
    const pct = Math.min((elapsed / duration) * 100, 100);
    progress.style.width = pct + "%";

    // Passage √† la question suivante
    if (elapsed >= duration) {
      clearInterval(questionTimer);
      currentQuestion = index + 1;     // ‚úÖ base sur l'index courant (pas l'ancien √©tat)
      showQuestion(currentQuestion);
    }
  }, 100);
}

/* ===================== Fin de quiz ===================== */
function finishQuiz(){
  clearInterval(questionTimer);
  questionTimer = null;

  // Bascule visuelle d'abord
  goTo(endPage);

  // Puis arr√™t propre de l'enregistrement -> d√©clenchera onstop (t√©l√©chargement + retour r√®gles)
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    try { mediaRecorder.stop(); } catch(e){}
  } else {
    // Garde-fou si jamais pas d'enregistrement
    setTimeout(()=>{ goTo(rulesPage); resetForNewRun(); }, 3000);
  }
}
</script>
</body>
</html>
